<project name="svnwiki" default="war" basedir=".">

  <property name="source" value="src" />   
  <property name="web" value="WebContent" />   
  <property name="build-classes" value="ant-build/classes" />   
  <property name="build-web" value="ant-build/web" />   
  <property name="reports" value="reports" />   
  <property name="war" value="${ant.project.name}.war" />   
  <property name="prepopulated-pages" value="net/hillsdon/svnwiki/web/vcintegration/prepopulated/**"/>

  <path id="classpath">
     <fileset dir="lib">
        <include name="*.jar" />
     </fileset>
     <fileset dir="${web}/WEB-INF/lib">
        <include name="*.jar" />
     </fileset>
  </path>    

  <target name="init">
     <mkdir dir="${build-classes}" />
     <mkdir dir="${build-web}" />
     <mkdir dir="${reports}" />
     <exec outputproperty="revision" executable="svnversion"/>
  </target>

  <target name="clean">
    <delete dir="${build-classes}" />
    <delete dir="${build-web}" />
    <delete dir="${reports}" />
    <delete file="${war}"/>
  </target>

  <target name="compile" depends="init">
    <javac srcdir="${source}"
           destdir="${build-classes}">
      <classpath refid="classpath" />
    </javac>
    <copy todir="${build-web}">
      <fileset dir="${web}">
        <include name="*/**"/>
      </fileset>
    </copy>
    <replace file="${build-web}/WEB-INF/templates/SiteTemplate.jsp" token="$BuildRevision$" value="${revision}"/>
    <copy todir="${build-classes}">
      <fileset dir="${source}">
        <include name="**/*.json"/>
        <include name="**/*.xml"/>
        <include name="${prepopulated-pages}"/>
        <include name="net/hillsdon/svnwiki/web/taglib/svnwiki.tld"/>
      </fileset>
    </copy>
  </target>

  <target name="taglibJar" depends="compile">
    <mkdir dir="${build-classes}/META-INF"/>
    <move file="${build-classes}/net/hillsdon/svnwiki/web/taglib/svnwiki.tld" tofile="${build-classes}/META-INF/svnwiki.tld"/>
    <jar destfile="WebContent/WEB-INF/lib/svnwiki-tlds.jar" >
      <fileset dir="${build-classes}">
        <include name="net/hillsdon/svnwiki/web/taglib/**/*.class"/>
      </fileset>
      <metainf dir="${build-classes}/META-INF">
        <include name="**/*"/>
      </metainf>
    </jar>
  </target>

  <target name="unitTests" depends="compile">
    <junit printsummary="yes" haltonfailure="yes">
      <formatter type="plain" usefile="false"/>
      <classpath>
        <path refid="classpath"/>
        <pathelement location="${build-classes}"/>
      </classpath>
      <formatter type="xml"/>
      <batchtest todir="${reports}">
        <fileset dir="${source}">
          <include name="**/Test*.java"/>
        </fileset>
      </batchtest>
    </junit>
  </target>

  <target name="war" depends="compile, taglibJar">
    <war warfile="${war}"
         webxml="${build-web}/WEB-INF/web.xml">
       <classes dir="${build-classes}">
         <include name="**/*.class"/>
         <include name="${prepopulated-pages}"/>
       </classes>
       <fileset dir="${build-web}">
         <include name="**/*"/>
         <exclude name="WEB-INF/**/*"/>
       </fileset>
       <webinf dir="${build-web}/WEB-INF" includes="**" />
    </war>
  </target>

</project>

